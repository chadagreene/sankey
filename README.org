
* Table of contents                               :toc_2:noexport:
- [[#introduction][Introduction]]
- [[#mass-flow-values][Mass flow values]]
  - [[#greenland][Greenland]]
- [[#latex][LaTeX]]

* Introduction

Sankey diagram for Greenland and Antarctica. Uses Emacs Org-Mode, Org Babel, tangling, and noweb to use code and tables to generate Sankey diagram values.

* Mass flow values
** Greenland

#+NAME: greenland_mass
| Label  | Description           |    Value | Reference                  |
|--------+-----------------------+----------+----------------------------|
| DR     | Drift                 |      200 |                            |
| RFZ    | Refreeze (after melt) |      100 | [[citet:reijmer_2012][Reijmer (2012)]]             |
| SF     | Snowfall              |      800 |                            |
| RF     | Rainfall              |       30 |                            |
| RF-LIQ | Rainfall runoff       |       50 |                            |
| CD     | Condensation          |       30 |                            |
| DP     | Deposition            |       20 |                            |
| FRET   | Frontal retreat       |       50 | [[citet:kochtitzky_2023][Kochtitzky (2023)]]          |
| SU     | Sublimation           |    24+16 | [[citet:lenaerts_2012][Lenaerts (2012)]]            |
| RU     | Runoff                |      500 |                            |
| DYN    | Dynamics              |      500 | [[citet:mankoff_2020_solid][Mankoff (2020)]]             |
| ICE    | Icebergs              | 250+50/2 | [[citet:enderlin_2013][Enderlin (2013)]] + 1/2 FRET |
| SUB    | Submarine\\melt       | 250+50/2 | [[citet:enderlin_2013][Enderlin (2013)]] + 1/2 FRET |
| EV     | Evaporation           |       35 |                            |
| BM     | Basal melt            |       25 | [[citet:karlsson_2021][Karlsson (2021)]]            |

#+NAME: sankey_values
#+BEGIN_SRC python :exports none :results output :var tbl=greenland_mass :export t :eval t
for t in tbl:
    print(f"{{{t[0]}/{t[1]}/{t[2]}}},", end='')
    if t != tbl[-1]:
        print("")
#+END_SRC


#+BEGIN_SRC bash :exports results :results verbatim :results none
convert -density 120 -background white -alpha remove -trim greenland.pdf greenland.png
#+END_SRC

[[./greenland.png]]


* LaTeX

+ See also: https://tex.stackexchange.com/questions/647813/

#+BEGIN_SRC latex :tangle greenland.tex
\documentclass[11pt]{article}
\usepackage{sankey}
\usepackage{tikz}
\usepackage{pgf}
\pagestyle{empty}

\begin{document}
\begin{tikzpicture}[remember picture, overlay, shift={(5.5,-5.5)}]

  \begin{sankeydiagram}
    %% \sankeyset{debug=true}
    
    \colorlet{water}[rgb]{cyan!75!blue!50!white}
    \colorlet{ice}[rgb]{gray!20!gray!20!gray!20}
    \colorlet{air}[rgb]{gray!1!gray!1!gray!1}
    \colorlet{red}[rgb]{red!50!orange!75!white}

    \sankeyset{
      every node/.style={angle=-90},
      start style=arrow,end style=arrow,
      %% fill/.style={fill=yellow!10,line width=0pt,draw=yellow!10},
      ratio=1mm/15,
      minimum radius=1mm,
      water/.style={fill/.style={draw=water,line width=0pt,fill=water,},},
      ice/.style={fill/.style={draw=ice,line width=0pt,fill=ice,},},
      air/.style={fill/.style={draw=air,line width=0pt,fill=air,},},
      ice-to-water/.style={fill/.style={fill=none, top color=ice, bottom color=water},},
      ice-to-air/.style={fill/.style={fill=none, top color=ice, bottom color=air},},
      water-to-air/.style={fill/.style={fill=none, top color=water, bottom color=air},},
      air-to-ice/.style={fill/.style={fill=none, top color=air, bottom color=ice},},
      red/.style={fill/.style={fill=none, top color=red, bottom color=red},},
      red-to-ice/.style={fill/.style={fill=none, top color=red, bottom color=ice},},
      water-to-ice/.style={fill/.style={fill=none, top color=water, bottom color=ice},},
      debug label/.style={
        overlay,
        draw,
        font=\ttfamily,
        text=debug color,text opacity=1,
        inner sep=.1em,
        fill=white,fill opacity=0.5,
        rounded corners=.1em,
        node contents={\name (\qty)},
      },
    }

    % storage of labels
    \newcommand\LabSet[2]{% node name, label
      \expandafter\edef\csname#1@Lab\endcsname{#2}}
    \newcommand\Lab[1]{% node name
      \csname#1@Lab\endcsname}
    % storage of quantities
    \newcommand\QSet[2]{% node name, quantity
      \expandafter\edef\csname#1@Q\endcsname{\fpeval{#2}}}
    \newcommand\Q[1]{% node name
      \csname#1@Q\endcsname}
    % all nodes with their name, label and quantity
    %% \newcommand\Q[1]{\sankeygetnodeqty{#1}}
    
    \sankeyset{
      def data/.code args={#1/#2/#3}{% node name/label/values
        \LabSet{#1}{#2}
        \QSet{#1}{#3}
        \typeout{#1: \Q{#1} Gt (\Lab{#1})}
      },
      def data/.list={
        <<sankey_values()>>
        {MELT/Surface melt/\Q{RU}+\Q{RFZ}},
        {GROSS/Gross\\accumulation/\Q{DP}+\Q{RFZ}+\Q{SF}+\Q{RF}+\Q{CD}},
        {DYN-FRET/Dynamics plus frontal retreat/\Q{DYN}+\Q{FRET}},
        {IL/Ice Loss/
          (\Q{SU}+\Q{RU}+\Q{BM}+\Q{DYN})-(\Q{SF}+\Q{RF}+\Q{CD}+\Q{DP})},
        {ML/Net mass Loss/\Q{FRET}+\Q{IL}}
      },
    }

    \sankeyset{ice} % color
        
    %% GROSS inputs
    \sankeynode{
      name=GROSS,
      quantity=\Q{GROSS}+\Q{IL}+\Q{FRET},
      at={0,0},
      % inputs
      forked={
        \Q{FRET}/GROSS-from-FRET,	% frontal retreat
        \Q{IL}/GROSS-from-IL,		% ice loss
        \Q{SF}/GROSS-from-SF,		% snowfall
        \Q{DP}/GROSS-from-DP,		% deposition
        \Q{CD}/GROSS-from-CD,		% condensation
        \Q{RF}/GROSS-from-RF,		% rainfall
        \Q{RFZ}/GROSS-from-RFZ		% refrozen melt
      },
    }
    \sankeyadvance{GROSS}{2cm}
    %% GROSS outputs
    \sankeyfork{GROSS}{
      \Q{SU}/GROSS-to-SU,
      \Q{BM}/GROSS-to-BM,
      \Q{DYN-FRET}/GROSS-to-DYN-FRET,
      \Q{MELT}/GROSS-to-MELT}

    
    %% BM
    \sankeynode{name=BM, quantity=\Q{BM}, at={[xshift=3mm, yshift=-3cm]GROSS-to-BM.center}, anchor=center}
    \sankeynode{name=DYN, quantity=\Q{DYN-FRET}, at={[xshift=-6mm, yshift=-1.5cm]BM.right}, anchor=left}
    \sankeynode{name=MELT-with-RF, quantity=\Q{MELT}+\Q{RF-LIQ}+\Q{RF},
      at={[xshift=-3mm, yshift=1.5cm]DYN.right}, anchor=left,
      forked={\Q{MELT}/MELT-wo-RF, \Q{RF}+\Q{RF-LIQ}/RF-in}}

    \sankeydubins[ice-to-water]{GROSS-to-BM}{BM}
    \sankeyadvance[water]{BM}{3cm}
    \sankeyadvance[water]{BM}{3cm}
    \sankeyend[water]{BM}

    %% DYN
    \sankeydubins{GROSS-to-DYN-FRET}{DYN}
    \sankeyfork{DYN}{\Q{ICE}/ICE-from-DYN, \Q{SUB}/SUB}
    \sankeyadvance[ice-to-water]{SUB}{4.5cm}
    \sankeyend[water]{SUB}
    \sankeynode{name=ICE, quantity=\Q{ICE}, at={[xshift=3mm]SUB.left}, anchor=right}
    \sankeydubins{ICE-from-DYN}{ICE}
    \sankeyend{ICE}

    %% SU
    \sankeynode{name=SU-out, quantity=\Q{SU},
      at={[xshift=10mm, yshift=-10mm]GROSS-to-SU.center}, anchor=center, angle=0}
    \sankeydubins[ice-to-air]{GROSS-to-SU}{SU-out}
    \sankeyend[air]{SU-out}

    %% MELT
    \sankeydubins[ice-to-water]{GROSS-to-MELT}{MELT-wo-RF}
    \sankeyadvance[water]{MELT-with-RF}{2cm}
    \sankeyfork{MELT-with-RF}{\Q{RU}+\Q{RF-LIQ}+\Q{RF}/RU-GROSS, \Q{RFZ}/RFZ-from-MELT}
    \sankeyadvance[water]{RU-GROSS}{1.5cm}
    \sankeyfork{RU-GROSS}{\Q{RU}+\Q{RF-LIQ}+\Q{RF}-\Q{EV}/RU-NET, \Q{EV}/EVAP}
    \sankeyadvance[water]{RU-NET}{2.5cm}
    \sankeyend[water]{RU-NET}
    
    %% RFZ
    \sankeynode{ name=RFZ-waypoint0, quantity=\Q{RFZ}, angle=90,
      at={[xshift=-20mm, yshift=0cm]RFZ-from-MELT.right}, anchor=right}
    \sankeynode{ name=RFZ-waypoint1, quantity=\Q{RFZ}, angle=90,
      at={[xshift=-20mm, yshift=0cm]GROSS-from-RFZ.right}, anchor=right}
    \sankeydubins[water]{RFZ-from-MELT}{RFZ-waypoint0}
    \sankeydubins[ice-to-water]{RFZ-waypoint0}{RFZ-waypoint1}
    \sankeydubins[ice]{RFZ-waypoint1}{GROSS-from-RFZ}

    %% EV
    \sankeynode{name=EV-out, quantity=\Q{EV}, at={[xshift=-10mm, yshift=-10mm]EVAP.center}, anchor=center, angle=180}
    \sankeydubins[water-to-air]{EVAP}{EV-out}
    \sankeyend[air]{EV-out}
    
    %%% INPUTS

    \sankeynode{name=SF, quantity=\Q{SF}, at={[xshift=0, yshift=3cm]GROSS-from-SF.center}, align=center}
    \sankeynode{name=DP, quantity=\Q{DP}, at={[xshift=-3mm, yshift=0]SF.right}, align=left}
    \sankeynode{name=CD, quantity=\Q{CD}, at={[xshift=-3mm, yshift=0]DP.right}, align=left}
    \sankeynode{name=RF-NET, quantity=\Q{RF}+\Q{RF-LIQ}, at={[xshift=-6mm, yshift=0]CD.right}, align=left}
    \sankeystart[water]{RF-NET}
    \sankeyadvance[water]{RF-NET}{0.5cm}

    \sankeydubins{SF}{GROSS-from-SF}
    \sankeydubins[air-to-ice]{DP}{GROSS-from-DP}
    \sankeydubins{CD}{GROSS-from-CD}
    \sankeyfork{RF-NET}{\Q{RF}/RFZ-from-RF-NET, \Q{RF-LIQ}/RF-LIQ-from-RF-NET}
    \sankeynode{name=RF-wpt1, quantity=\Q{RF}+\Q{RF-LIQ}, at={[xshift=-10mm]GROSS-to-MELT.right}, align=right}
    \sankeydubins[water]{RF-NET}{RF-wpt1}
    \sankeydubins[water]{RF-wpt1}{RF-in}
    
    \sankeystart[air]{DP}
    \sankeystart{SF}
    \sankeystart{CD}

    \sankeyset{ice}
    \sankeynode{ name=ML, quantity=\Q{FRET}+\Q{IL}, at={[xshift=8mm]SF.left}, anchor=right}
    \sankeystart[red]{ML}
    \sankeyadvance[red-to-ice]{ML}{1cm}
    \sankeyfork{ML}{\Q{FRET}/FRET, \Q{IL}/IL}
    \sankeydubins[minimum radius=2mm]{IL}{GROSS-from-IL}
    \sankeyadvance{FRET}{1cm}
    \sankeydubins{FRET}{GROSS-from-FRET}


    %% DRIFT
    \sankeynode{name=DRIFT-OUT, quantity=33, at={(3mm, -8mm)}, angle=150}
    \sankeynode{name=DRIFT-IN, quantity=33, at={(-3mm, -8mm)}, angle=210}
    \sankeydubins[minimum radius=5mm]{DRIFT-OUT}{DRIFT-IN}
    \sankeystart{DRIFT-OUT}
    \sankeyend{DRIFT-IN}
    \node[anchor=center, align=center, rotate=0, shift=({0,0})] at (0,-15mm) {Drifting (\Q{DR})};
    
    \node[anchor=south east, align=center, shift=({2mm,-15mm})] at (EV-out.right) {Evaporation\\(\Q{EV})};

    \node[anchor=center, align=center, shift=({0mm,-1cm})] at (RU-NET.center) {Net Runoff\\(\sankeygetnodeqty{RU-NET})};

    \node[anchor=center, align=center, shift=({0mm,-1cm})] at (SUB.center) {Submarine\\melt (\sankeygetnodeqty{SUB})};

    \node[anchor=center, align=center, shift=({0mm,-1cm})] at (ICE.center) {Calving\\(\sankeygetnodeqty{ICE})};

    \node[anchor=center, align=left, shift=({0.75cm, -1cm})] at (BM.right) {Basal\\melt (\sankeygetnodeqty{BM})};

    \node[anchor=center, align=center, shift=({0mm,1cm})] at (DYN.center) {Dynamics\\(\sankeygetnodeqty{DYN})};

    \node[anchor=center, align=center, shift=({0mm,0.5cm})] at (RU-GROSS.center) {Surface\\water\\(\sankeygetnodeqty{RU-GROSS})};

    \node[anchor=center, align=center, shift=({0mm,-1cm})] at (GROSS-to-MELT.center) {Melting \\(\sankeygetnodeqty{GROSS-to-MELT})};

    \node[anchor=center, align=center, shift=({-2cm,-1.25cm})] at (RFZ-from-MELT.center) {Refreezing (\sankeygetnodeqty{RFZ-from-MELT})};

    \node[anchor=center, align=center, shift=({0.25cm,-1cm})] at (SU-out.center) {Sublimation\\(\sankeygetnodeqty{SU-out})};

    \node[anchor=center, align=center, shift=({0cm,2.25cm})] at (ML.center) {Mass loss (\sankeygetnodeqty{ML}) = \\SMB \& Dynamics (\sankeygetnodeqty{IL})\\+ Frontal retreat (\sankeygetnodeqty{FRET})};

    \node[anchor=center, align=center, shift=({0cm,0.75cm})] at (SF.center) {Snowfall  (\sankeygetnodeqty{SF})};

    \node[anchor=east, align=center, rotate=-90, shift=({-3mm,0cm})] at (DP.center) {Deposition (\sankeygetnodeqty{DP})};

    \node[anchor=east, align=center, rotate=-90, shift=({-3mm,0cm})] at (CD.center) {Condensation (\sankeygetnodeqty{CD})};

    \node[anchor=center, align=center, rotate=-90, shift=({-15mm,0cm})] at (RF-NET-old.center) {Rainfall (\sankeygetnodeqty{RF-NET})};
    
  \end{sankeydiagram}
\end{tikzpicture}
\end{document}
#+END_SRC
